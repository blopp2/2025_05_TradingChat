document.addEventListener("DOMContentLoaded",(()=>{const e={screenshotInfo:document.getElementById("screenshot-info"),newAnalysisBtn:document.getElementById("new-analysis-btn"),askQuestionBtn:document.getElementById("ask-question-btn"),textarea:document.getElementById("question"),resultEl:document.getElementById("result"),statusEl:document.getElementById("status")};let t=[],n=null,r=null;function s(e){t.push(e),t.length>4&&(t=t.slice(-4))}async function a(t){e.newAnalysisBtn.disabled=t,e.askQuestionBtn.disabled=t,e.textarea.disabled=t,e.statusEl.style.display=t?"block":"none",!t&&r&&r.abort()}function o(t){const n="string"!=typeof(r=t)?(console.warn("formatResponse received non-string input:",r),""):l(r).replace(/\*\*(.*?)\*\*/g,"<strong>$1</strong>").replace(/\*(.*?)\*/g,"<em>$1</em>").replace(/\n\n+/g,"</p><p>").replace(/\n/g,"<br>");var r;e.resultEl.innerHTML=`<div class="response">${n}</div>`}function i(t){e.resultEl.innerHTML=`<div class="error">‚ùå ${l(t)}</div>`}function l(e){return"string"!=typeof e?(console.warn("escapeHtml received non-string input:",e),""):e.replace(/&/g,"&amp;").replace(/</g,"&lt;").replace(/>/g,"&gt;").replace(/"/g,"&quot;").replace(/'/g,"&#039;")}async function c(e){const{OPENAI_KEY:t}=await chrome.storage.sync.get("OPENAI_KEY");if(!t)throw new Error("Bitte API-Key in den Einstellungen hinterlegen");const n=new AbortController,r=setTimeout((()=>n.abort()),6e4);try{const r={model:"gpt-4.1-mini",messages:e,max_tokens:1e3},s=await fetch("https://api.openai.com/v1/chat/completions",{method:"POST",headers:{"Content-Type":"application/json",Authorization:`Bearer ${t}`},body:JSON.stringify(r),signal:n.signal});if(!s.ok){const e=await s.json().catch((()=>({})));throw new Error(e.error?.message||`API-Fehler: ${s.status}`)}return await s.json()}finally{clearTimeout(r)}}e.newAnalysisBtn.addEventListener("click",(async function(){if(confirm("Die Bildanalyse verbraucht viele API-Tokens. Fortfahren?"))try{await a(!0),e.resultEl.textContent="",n=await async function(){try{const e=await chrome.runtime.sendMessage({action:"captureScreenshot"});if(e.error)throw new Error(e.error);return e.dataUrl}catch(e){throw console.error("Screenshot fehlgeschlagen:",e),e}}(),function(){const t=new Date;e.screenshotInfo.textContent=`üì∏ Letzter Screenshot: ${t.toLocaleString()}`}(),t=[],s({role:"user",content:[{type:"text",text:"Analysiere diesen TradingView-Chart technisch. Erkenne Muster, Indikatoren und m√∂gliche Handelsm√∂glichkeiten."},{type:"image_url",image_url:{url:n}}]});const r=await c(t);s({role:"assistant",content:r}),o(r)}catch(e){i(e.message)}finally{await a(!1)}})),e.askQuestionBtn.addEventListener("click",(async function(){const n=e.textarea.value.trim();if(n)try{await a(!0),r=new AbortController,s({role:"user",content:[{type:"text",text:n}]});const e=await c(t);s({role:"assistant",content:e}),o(e)}catch(e){"AbortError"!==e.name&&i(e.message)}finally{r=null,await a(!1)}else i("Bitte geben Sie eine Frage ein")}))}));